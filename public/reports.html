<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - Board Directives</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    
    <style>
        * { 
            font-family: 'Google Sans', 'Roboto', sans-serif; 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        :root {
            --cbn-darkest: #0D2818;
            --cbn-dark: #1B5E20;
            --cbn-primary: #2E7D32;
            --cbn-medium: #43A047;
            --cbn-light: #66BB6A;
            --cbn-pale: #E8F5E9;
            --cbn-cream: #F1F8F4;
            --red-critical: #C62828;
            --bg-page: #F8F9FA;
        }
        
        body {
            background: var(--bg-page);
            color: #202124;
            height: 100vh;
            overflow: hidden;
        }
        
        .sidebar {
            width: 256px;
            background: white;
            border-right: 1px solid #DADCE0;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
        }
        
        .nav-item {
            padding: 12px 20px;
            margin: 2px 8px;
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 12px;
            color: #5F6368;
            font-weight: 500;
            font-size: 14px;
        }
        
        .nav-item:hover {
            background: var(--cbn-pale);
        }
        
        .nav-item.active {
            background: var(--cbn-pale);
            color: var(--cbn-dark);
            font-weight: 700;
        }
        
        .main-content {
            margin-left: 256px;
            height: 100vh;
            overflow-y: auto;
            padding: 24px;
        }
        
        .view-section {
            display: none;
        }
        
        .view-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #DADCE0;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .stat-card:hover {
            box-shadow: 0 1px 3px rgba(60,64,67,0.3), 0 4px 8px rgba(60,64,67,0.15);
        }
        
        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #DADCE0;
        }
        
        .metric-big {
            font-size: 2.5rem;
            font-weight: 400;
            line-height: 1;
            font-family: 'Google Sans';
        }
        
        .btn-subtle {
            background: var(--bg-page);
            border: none;
            padding: 8px 16px;
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            font-size: 14px;
            color: #5F6368;
        }
        
        .btn-subtle:hover {
            background: #E8EAED;
        }
        
        .btn-subtle:active {
            background: #DADCE0;
            transform: translateY(1px);
        }
        
        .btn-subtle.active {
            background: var(--cbn-pale);
            color: var(--cbn-dark);
        }
        
        .btn-primary {
            background: var(--cbn-primary);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            font-size: 14px;
        }
        
        .btn-primary:hover {
            background: var(--cbn-dark);
            box-shadow: 0 1px 3px rgba(60,64,67,0.3), 0 4px 8px rgba(60,64,67,0.15);
        }
        
        .btn-primary:active {
            transform: translateY(1px);
        }
        
        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }
        
        .badge-green { background: var(--cbn-pale); color: var(--cbn-dark); }
        .badge-red { background: #FCE8E6; color: var(--red-critical); }
        .badge-yellow { background: #FEF3C7; color: #92400E; }
        .badge-blue { background: #E3F2FD; color: #1565C0; }
        
        .progress-bar {
            height: 6px;
            background: #E8EAED;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .progress-fill {
            height: 100%;
            transition: width 0.8s ease;
            border-radius: 3px;
            background: var(--cbn-primary);
        }
        
        .filter-bar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .filter-bar select, .filter-bar input {
            padding: 8px 16px;
            border: 1px solid #DADCE0;
            border-radius: 24px;
            font-size: 14px;
            background: white;
        }
        
        .filter-bar input {
            min-width: 240px;
        }
        
        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #DADCE0;
        }
        
        .pagination button {
            padding: 8px 16px;
            border: 1px solid #DADCE0;
            background: white;
            border-radius: 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #5F6368;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .pagination button:hover:not(:disabled) {
            background: var(--cbn-pale);
        }
        
        .pagination button.active {
            background: var(--cbn-primary);
            color: white;
            border-color: var(--cbn-primary);
        }
        
        .pagination button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .item-card {
            background: white;
            border: 1px solid #DADCE0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .item-card:hover {
            box-shadow: 0 1px 3px rgba(60,64,67,0.3), 0 4px 8px rgba(60,64,67,0.15);
        }
        
        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #E8EAED;
            color: #5F6368;
            font-size: 11px;
            font-weight: bold;
            cursor: help;
            margin-left: 4px;
            position: relative;
        }
        
        .tooltip-icon:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 12px;
            background: #202124;
            color: white;
            font-size: 12px;
            font-weight: normal;
            white-space: nowrap;
            border-radius: 8px;
            z-index: 1000;
            margin-bottom: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .tooltip-icon:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid #202124;
            margin-bottom: 2px;
            z-index: 1001;
        }
        
        @media print {
            .sidebar, .no-print, .filter-bar, .pagination, .tooltip-icon { display: none !important; }
            body { background: white; overflow: visible !important; }
            .main-content { margin-left: 0; padding: 0; overflow: visible !important; height: auto !important; }
            .view-section { display: block !important; page-break-after: always; }
            .view-section:last-child { page-break-after: auto; }
            .stat-card, .chart-card, .item-card { page-break-inside: avoid; box-shadow: none !important; border: 1px solid #ddd; }
            .grid { page-break-inside: avoid; }
            canvas { max-height: 300px !important; }
            @page { margin: 1.5cm; }
        }
    </style>
</head>
<body>

    <!-- Loading -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-90 items-center justify-center hidden z-50">
        <div class="text-center">
            <div class="inline-block w-12 h-12 border-4 border-gray-200 border-t-green-600 rounded-full animate-spin mb-4"></div>
            <p class="text-gray-700 font-medium">Loading data...</p>
        </div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar no-print">
        <div class="p-6 border-b border-gray-200">
            <a href="/" class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
                    <svg class="w-6 h-6 text-green-700" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm9.707 5.707a1 1 0 00-1.414-1.414L9 12.586l-1.293-1.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div>
                    <h1 class="font-bold text-lg" style="color: var(--cbn-dark);">Analytics</h1>
                    <p class="text-xs text-gray-500">Board Directives</p>
                </div>
            </a>
        </div>

        <!-- Source Selector -->
        <div class="p-4">
            <div class="flex gap-2">
                <button id="src-cg" onclick="switchSource('CG')" class="btn-subtle active flex-1">CG</button>
                <button id="src-board" onclick="switchSource('Board')" class="btn-subtle flex-1">Board</button>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="py-2">
            <a href="/index.html" class="nav-item" style="text-decoration: none; color: inherit;">
                <span>‚Üê</span>
                <span>Back to Dashboard</span>
            </a>
            <div class="nav-item active" onclick="showView('overview')">
                <span>üìä</span>
                <span>Overview</span>
            </div>
            <div class="nav-item" onclick="showView('outcomes')">
                <span>üìà</span>
                <span>Outcome Analysis</span>
            </div>
            <div class="nav-item" onclick="showView('directives')">
                <span>üìã</span>
                <span>Directive Details</span>
            </div>
            <div class="nav-item" onclick="showView('timeline')">
                <span>‚è±Ô∏è</span>
                <span>Timeline Tracking</span>
            </div>
            <div class="nav-item" onclick="showView('owners')">
                <span>üë•</span>
                <span>Process Owners</span>
            </div>
        </nav>

        <!-- Actions -->
        <div class="p-4 border-t border-gray-200 mt-auto">
            <button onclick="window.print()" class="btn-subtle w-full mb-2">
                üñ®Ô∏è Print Report
            </button>
            <button onclick="exportReport()" class="btn-primary w-full">
                üì• Export Excel
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        
        <!-- Overview Section -->
        <div id="view-overview" class="view-section active">
            <div class="mb-6">
                <h2 class="text-3xl font-normal mb-2" style="color: var(--cbn-darkest);">Overview</h2>
                <p class="text-sm text-gray-600" id="current-date"></p>
            </div>

            <!-- Outcome-Based Stats -->
            <div class="grid grid-cols-5 gap-4 mb-6">
                <div class="stat-card">
                    <div class="flex items-center text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">
                        Total Outcomes
                        <span class="tooltip-icon" data-tooltip="Total individual outcomes across all directives">‚ÑπÔ∏è</span>
                    </div>
                    <div class="metric-big" style="color: var(--cbn-dark);" id="ov-total-outcomes">0</div>
                    <div class="text-xs text-gray-500 mt-2">From <span id="ov-total-directives">0</span> directives</div>
                </div>
                <div class="stat-card">
                    <div class="flex items-center text-xs font-medium uppercase tracking-wide mb-2" style="color: var(--cbn-primary);">
                        Completed
                        <span class="tooltip-icon" data-tooltip="Outcomes marked as completed">‚ÑπÔ∏è</span>
                    </div>
                    <div class="metric-big" style="color: var(--cbn-primary);" id="ov-completed">0</div>
                    <div class="text-xs font-medium mt-2" style="color: var(--cbn-primary);" id="ov-completed-pct">0%</div>
                </div>
                <div class="stat-card">
                    <div class="flex items-center text-xs font-medium uppercase tracking-wide mb-2" style="color: var(--cbn-medium);">
                        Being Implemented
                        <span class="tooltip-icon" data-tooltip="Outcomes actively in progress">‚ÑπÔ∏è</span>
                    </div>
                    <div class="metric-big" style="color: var(--cbn-medium);" id="ov-implementing">0</div>
                    <div class="text-xs font-medium mt-2" style="color: var(--cbn-medium);" id="ov-implementing-pct">0%</div>
                </div>
                <div class="stat-card">
                    <div class="flex items-center text-xs font-medium uppercase tracking-wide mb-2 text-orange-600">
                        Delayed
                        <span class="tooltip-icon" data-tooltip="Outcomes marked as delayed">‚ÑπÔ∏è</span>
                    </div>
                    <div class="metric-big text-orange-600" id="ov-delayed">0</div>
                    <div class="text-xs font-medium mt-2 text-orange-600" id="ov-delayed-pct">0%</div>
                </div>
                <div class="stat-card">
                    <div class="flex items-center text-xs font-medium uppercase tracking-wide mb-2 text-gray-500">
                        Not Started
                        <span class="tooltip-icon" data-tooltip="Outcomes not yet begun">‚ÑπÔ∏è</span>
                    </div>
                    <div class="metric-big text-gray-500" id="ov-not-started">0</div>
                    <div class="text-xs font-medium mt-2 text-gray-500" id="ov-not-started-pct">0%</div>
                </div>
            </div>

            <!-- Directive-Level Completion -->
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="stat-card bg-green-50">
                    <div class="flex items-center text-xs font-medium text-gray-700 uppercase tracking-wide mb-2">
                        Full Completion
                        <span class="tooltip-icon" data-tooltip="Directives with ALL outcomes completed">‚ÑπÔ∏è</span>
                    </div>
                    <div class="text-4xl font-light text-green-700" id="ov-full-completion">0</div>
                    <div class="text-xs text-green-700 mt-1" id="ov-full-completion-pct">0%</div>
                </div>
                <div class="stat-card bg-blue-50">
                    <div class="flex items-center text-xs font-medium text-gray-700 uppercase tracking-wide mb-2">
                        Partial Completion
                        <span class="tooltip-icon" data-tooltip="Directives with SOME outcomes completed">‚ÑπÔ∏è</span>
                    </div>
                    <div class="text-4xl font-light text-blue-700" id="ov-partial-completion">0</div>
                    <div class="text-xs text-blue-700 mt-1" id="ov-partial-completion-pct">0%</div>
                </div>
                <div class="stat-card bg-red-50">
                    <div class="flex items-center text-xs font-medium text-gray-700 uppercase tracking-wide mb-2">
                        Non-Responsive
                        <span class="tooltip-icon" data-tooltip="Directives with 3+ reminders, no response">‚ÑπÔ∏è</span>
                    </div>
                    <div class="text-4xl font-light text-red-700" id="ov-non-responsive">0</div>
                    <div class="text-xs text-red-700 mt-1" id="ov-non-responsive-pct">0%</div>
                </div>
            </div>

            <!-- Summary -->
            <div class="stat-card mb-6">
                <h3 class="text-base font-medium mb-2 flex items-center" style="color: var(--cbn-dark);">
                    Strategic Summary
                    <span class="tooltip-icon" data-tooltip="Overall performance assessment">‚ÑπÔ∏è</span>
                </h3>
                <p id="ov-summary" class="text-gray-700 leading-relaxed text-sm"></p>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-2 gap-6">
                <div class="chart-card">
                    <h3 class="text-base font-medium mb-4" style="color: var(--cbn-dark);">Outcome Status Distribution</h3>
                    <canvas id="ov-outcome-chart" height="200"></canvas>
                </div>
                <div class="chart-card">
                    <h3 class="text-base font-medium mb-4" style="color: var(--cbn-dark);">Directive Completion Status</h3>
                    <canvas id="ov-directive-chart" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Outcome Analysis Section -->
        <div id="view-outcomes" class="view-section">
            <div class="mb-6">
                <h2 class="text-3xl font-normal mb-2" style="color: var(--cbn-darkest);">Outcome Analysis</h2>
                <p class="text-sm text-gray-600">Individual outcome status tracking</p>
            </div>

            <!-- Outcome Metrics -->
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="stat-card">
                    <div class="text-xs font-medium uppercase tracking-wide mb-2" style="color: var(--cbn-primary);">Completed</div>
                    <div class="text-4xl font-light" style="color: var(--cbn-primary);" id="out-completed">0</div>
                    <div class="text-xs mt-2" style="color: var(--cbn-primary);" id="out-completed-pct">0%</div>
                </div>
                <div class="stat-card">
                    <div class="text-xs font-medium uppercase tracking-wide mb-2" style="color: var(--cbn-medium);">Being Implemented</div>
                    <div class="text-4xl font-light" style="color: var(--cbn-medium);" id="out-implementing">0</div>
                    <div class="text-xs mt-2" style="color: var(--cbn-medium);" id="out-implementing-pct">0%</div>
                </div>
                <div class="stat-card">
                    <div class="text-xs font-medium uppercase tracking-wide mb-2 text-orange-600">Delayed</div>
                    <div class="text-4xl font-light text-orange-600" id="out-delayed">0</div>
                    <div class="text-xs text-orange-600 mt-2" id="out-delayed-pct">0%</div>
                </div>
                <div class="stat-card">
                    <div class="text-xs font-medium uppercase tracking-wide mb-2 text-gray-500">Not Started</div>
                    <div class="text-4xl font-light text-gray-500" id="out-not-started">0</div>
                    <div class="text-xs text-gray-500 mt-2" id="out-not-started-pct">0%</div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-6 mb-6">
                <div class="chart-card">
                    <h3 class="text-base font-medium mb-4" style="color: var(--cbn-dark);">Status Distribution</h3>
                    <canvas id="outcome-status-chart" height="200"></canvas>
                </div>
                <div class="chart-card">
                    <h3 class="text-base font-medium mb-4" style="color: var(--cbn-dark);">Top 10: Most Outcomes</h3>
                    <canvas id="outcome-by-directive-chart" height="200"></canvas>
                </div>
            </div>

            <!-- Problematic Outcomes -->
            <div class="chart-card">
                <h3 class="text-base font-medium mb-4" style="color: var(--cbn-dark);">
                    ‚ö†Ô∏è Directives with Most Delayed/Not Started Outcomes
                </h3>
                <div id="problematic-outcomes"></div>
            </div>
        </div>

        <!-- Directive Details Section -->
        <div id="view-directives" class="view-section">
            <div class="mb-6">
                <h2 class="text-3xl font-normal mb-2" style="color: var(--cbn-darkest);">Directive Details</h2>
                <p class="text-sm text-gray-600">Full list with completion tracking</p>
            </div>

            <!-- Filters -->
            <div class="chart-card">
                <div class="filter-bar no-print">
                    <select id="dir-filter-status" class="flex-1">
                        <option value="all">All Statuses</option>
                        <option value="full">Full Completion</option>
                        <option value="partial">Partial Completion</option>
                        <option value="none">No Completion</option>
                    </select>
                    <select id="dir-filter-sort" class="flex-1">
                        <option value="completion-desc">Completion Rate ‚Üì</option>
                        <option value="completion-asc">Completion Rate ‚Üë</option>
                        <option value="outcomes-desc">Most Outcomes</option>
                    </select>
                    <input type="text" id="dir-search" placeholder="Search directives...">
                </div>

                <div id="directives-list"></div>
            </div>
        </div>

        <!-- Timeline Section -->
        <div id="view-timeline" class="view-section">
            <div class="mb-6">
                <h2 class="text-3xl font-normal mb-2" style="color: var(--cbn-darkest);">Timeline Tracking</h2>
                <p class="text-sm text-gray-600">Deadlines and implementation schedules</p>
            </div>

            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="stat-card bg-red-50">
                    <div class="text-xs font-medium uppercase tracking-wide mb-2 text-red-700">Overdue</div>
                    <div class="text-5xl font-light text-red-700 mb-2" id="tl-overdue">0</div>
                    <div class="text-xs text-red-700">Past deadline</div>
                </div>
                <div class="stat-card bg-yellow-50">
                    <div class="text-xs font-medium uppercase tracking-wide mb-2 text-yellow-700">Due Soon</div>
                    <div class="text-5xl font-light text-yellow-700 mb-2" id="tl-due-soon">0</div>
                    <div class="text-xs text-yellow-700">Within 30 days</div>
                </div>
                <div class="stat-card">
                    <div class="text-xs font-medium text-gray-600 uppercase tracking-wide mb-2">No Timeline</div>
                    <div class="text-5xl font-light text-gray-600 mb-2" id="tl-no-date">0</div>
                    <div class="text-xs text-gray-600">Needs scheduling</div>
                </div>
            </div>

            <div class="chart-card mb-6">
                <h3 class="text-base font-medium mb-4" style="color: var(--cbn-dark);">Timeline Status</h3>
                <canvas id="timeline-chart" height="150"></canvas>
            </div>

            <div class="chart-card">
                <h3 class="text-base font-medium mb-4" style="color: var(--cbn-dark);">üö® Overdue Directives</h3>
                <div id="overdue-list"></div>
            </div>
        </div>

        <!-- Process Owners Section -->
        <div id="view-owners" class="view-section">
            <div class="mb-6">
                <h2 class="text-3xl font-normal mb-2" style="color: var(--cbn-darkest);">Process Owner Performance</h2>
                <p class="text-sm text-gray-600">Ranked by outcome completion rate</p>
            </div>

            <div class="chart-card mb-6">
                <h3 class="text-base font-medium mb-4" style="color: var(--cbn-dark);">Top 10 Performers</h3>
                <canvas id="top-owners-chart" height="300"></canvas>
            </div>

            <!-- Filters -->
            <div class="chart-card">
                <div class="filter-bar no-print">
                    <select id="owner-filter-performance" class="flex-1">
                        <option value="all">All Performance</option>
                        <option value="excellent">Excellent (80%+)</option>
                        <option value="good">Good (60-79%)</option>
                        <option value="needs-improvement">Needs Improvement (<60%)</option>
                    </select>
                    <select id="owner-filter-sort" class="flex-1">
                        <option value="completion-desc">Completion Rate ‚Üì</option>
                        <option value="outcomes-desc">Most Outcomes</option>
                        <option value="directives-desc">Most Directives</option>
                    </select>
                    <input type="text" id="owner-search" placeholder="Search owners...">
                </div>

                <div id="owners-list"></div>
            </div>
        </div>

    </main>

    <script>
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:3001/api'
            : 'https://directives-new.onrender.com/api';
        
        let currentSource = 'CG';
        let allDirectives = [];
        let charts = {};
        
        // Pagination & filter state
        let dirCurrentPage = 1;
        let dirPageSize = 15;
        let ownerCurrentPage = 1;
        let ownerPageSize = 15;
        let dirFilters = { status: 'all', sort: 'completion-desc', search: '' };
        let ownerFilters = { performance: 'all', sort: 'completion-desc', search: '' };

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-GB', {
                day: '2-digit', month: 'long', year: 'numeric'
            });
            setupEventListeners();
            loadReport();
        });

        function setupEventListeners() {
            // Directive filters
            document.getElementById('dir-filter-status').addEventListener('change', (e) => {
                dirFilters.status = e.target.value;
                dirCurrentPage = 1;
                renderDirectivesList(getFilteredDirectives());
            });
            
            document.getElementById('dir-filter-sort').addEventListener('change', (e) => {
                dirFilters.sort = e.target.value;
                dirCurrentPage = 1;
                renderDirectivesList(getFilteredDirectives());
            });
            
            let dirSearchTimeout;
            document.getElementById('dir-search').addEventListener('input', (e) => {
                clearTimeout(dirSearchTimeout);
                dirSearchTimeout = setTimeout(() => {
                    dirFilters.search = e.target.value.toLowerCase();
                    dirCurrentPage = 1;
                    renderDirectivesList(getFilteredDirectives());
                }, 300);
            });
            
            // Owner filters
            document.getElementById('owner-filter-performance').addEventListener('change', (e) => {
                ownerFilters.performance = e.target.value;
                ownerCurrentPage = 1;
                renderOwnersList(getFilteredOwners());
            });
            
            document.getElementById('owner-filter-sort').addEventListener('change', (e) => {
                ownerFilters.sort = e.target.value;
                ownerCurrentPage = 1;
                renderOwnersList(getFilteredOwners());
            });
            
            let ownerSearchTimeout;
            document.getElementById('owner-search').addEventListener('input', (e) => {
                clearTimeout(ownerSearchTimeout);
                ownerSearchTimeout = setTimeout(() => {
                    ownerFilters.search = e.target.value.toLowerCase();
                    ownerCurrentPage = 1;
                    renderOwnersList(getFilteredOwners());
                }, 300);
            });
        }

        function showLoading(show = true) {
            document.getElementById('loading-overlay').classList.toggle('hidden', !show);
            document.getElementById('loading-overlay').classList.toggle('flex', show);
        }

        function showView(viewName) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function switchSource(source) {
            currentSource = source;
            document.getElementById('src-cg').classList.toggle('active', source === 'CG');
            document.getElementById('src-board').classList.toggle('active', source === 'Board');
            loadReport();
        }

        async function loadReport() {
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/directives?source=${currentSource}`);
                const result = await response.json();
                
                if (result.success) {
                    allDirectives = result.data;
                    renderAll();
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading data');
            } finally {
                showLoading(false);
            }
        }

        function renderAll() {
            renderOverview();
            renderOutcomes();
            renderDirectives();
            renderTimeline();
            renderOwners();
        }

        function renderOverview() {
            // Calculate outcome stats
            let totalOutcomes = 0;
            let completed = 0;
            let implementing = 0;
            let delayed = 0;
            let notStarted = 0;
            
            let fullCompletion = 0;
            let partialCompletion = 0;
            let nonResponsive = 0;
            
            allDirectives.forEach(d => {
                if (d.outcomes && d.outcomes.length > 0) {
                    const outcomeStats = {
                        total: d.outcomes.length,
                        completed: d.outcomes.filter(o => o.status === 'Completed').length
                    };
                    
                    totalOutcomes += d.outcomes.length;
                    completed += outcomeStats.completed;
                    implementing += d.outcomes.filter(o => o.status === 'Being Implemented').length;
                    delayed += d.outcomes.filter(o => o.status === 'Delayed').length;
                    notStarted += d.outcomes.filter(o => o.status === 'Not Started').length;
                    
                    if (outcomeStats.completed === outcomeStats.total) fullCompletion++;
                    else if (outcomeStats.completed > 0) partialCompletion++;
                }
                
                if (d.isResponsive === false) nonResponsive++;
            });
            
            // Update DOM
            document.getElementById('ov-total-outcomes').textContent = totalOutcomes;
            document.getElementById('ov-total-directives').textContent = allDirectives.length;
            document.getElementById('ov-completed').textContent = completed;
            document.getElementById('ov-completed-pct').textContent = totalOutcomes > 0 ? `${Math.round((completed / totalOutcomes) * 100)}%` : '0%';
            document.getElementById('ov-implementing').textContent = implementing;
            document.getElementById('ov-implementing-pct').textContent = totalOutcomes > 0 ? `${Math.round((implementing / totalOutcomes) * 100)}%` : '0%';
            document.getElementById('ov-delayed').textContent = delayed;
            document.getElementById('ov-delayed-pct').textContent = totalOutcomes > 0 ? `${Math.round((delayed / totalOutcomes) * 100)}%` : '0%';
            document.getElementById('ov-not-started').textContent = notStarted;
            document.getElementById('ov-not-started-pct').textContent = totalOutcomes > 0 ? `${Math.round((notStarted / totalOutcomes) * 100)}%` : '0%';
            
            document.getElementById('ov-full-completion').textContent = fullCompletion;
            document.getElementById('ov-full-completion-pct').textContent = allDirectives.length > 0 ? `${Math.round((fullCompletion / allDirectives.length) * 100)}%` : '0%';
            document.getElementById('ov-partial-completion').textContent = partialCompletion;
            document.getElementById('ov-partial-completion-pct').textContent = allDirectives.length > 0 ? `${Math.round((partialCompletion / allDirectives.length) * 100)}%` : '0%';
            document.getElementById('ov-non-responsive').textContent = nonResponsive;
            document.getElementById('ov-non-responsive-pct').textContent = allDirectives.length > 0 ? `${Math.round((nonResponsive / allDirectives.length) * 100)}%` : '0%';
            
            // Summary text
            const completionRate = totalOutcomes > 0 ? Math.round((completed / totalOutcomes) * 100) : 0;
            const grade = completionRate >= 80 ? 'Excellent' : completionRate >= 70 ? 'Good' : completionRate >= 60 ? 'Satisfactory' : 'Needs Improvement';
            
            document.getElementById('ov-summary').innerHTML = `
                <strong>Overall Performance: ${grade}</strong>. 
                ${completed} of ${totalOutcomes} outcomes completed (${completionRate}%). 
                ${fullCompletion} directives fully completed, ${partialCompletion} partially completed. 
                ${nonResponsive > 0 ? `<span style="color: var(--red-critical);"> ‚ö†Ô∏è ${nonResponsive} non-responsive directive(s) require immediate attention.</span>` : ''}
            `;
            
            // Outcome chart
            if (charts.outcomeChart) charts.outcomeChart.destroy();
            const ctx1 = document.getElementById('ov-outcome-chart').getContext('2d');
            charts.outcomeChart = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'Being Implemented', 'Delayed', 'Not Started'],
                    datasets: [{
                        data: [completed, implementing, delayed, notStarted],
                        backgroundColor: ['#43A047', '#66BB6A', '#FB8C00', '#9E9E9E'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { size: 11 }, padding: 10 } }
                    }
                }
            });
            
            // Directive chart
            if (charts.directiveChart) charts.directiveChart.destroy();
            const ctx2 = document.getElementById('ov-directive-chart').getContext('2d');
            charts.directiveChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Full Completion', 'Partial Completion', 'Non-Responsive'],
                    datasets: [{
                        data: [fullCompletion, partialCompletion, nonResponsive],
                        backgroundColor: ['#43A047', '#2196F3', '#C62828'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { display: false } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function renderOutcomes() {
            let totalOutcomes = 0;
            let completed = 0;
            let implementing = 0;
            let delayed = 0;
            let notStarted = 0;
            
            allDirectives.forEach(d => {
                if (d.outcomes && d.outcomes.length > 0) {
                    totalOutcomes += d.outcomes.length;
                    completed += d.outcomes.filter(o => o.status === 'Completed').length;
                    implementing += d.outcomes.filter(o => o.status === 'Being Implemented').length;
                    delayed += d.outcomes.filter(o => o.status === 'Delayed').length;
                    notStarted += d.outcomes.filter(o => o.status === 'Not Started').length;
                }
            });
            
            document.getElementById('out-completed').textContent = completed;
            document.getElementById('out-completed-pct').textContent = totalOutcomes > 0 ? `${Math.round((completed / totalOutcomes) * 100)}%` : '0%';
            document.getElementById('out-implementing').textContent = implementing;
            document.getElementById('out-implementing-pct').textContent = totalOutcomes > 0 ? `${Math.round((implementing / totalOutcomes) * 100)}%` : '0%';
            document.getElementById('out-delayed').textContent = delayed;
            document.getElementById('out-delayed-pct').textContent = totalOutcomes > 0 ? `${Math.round((delayed / totalOutcomes) * 100)}%` : '0%';
            document.getElementById('out-not-started').textContent = notStarted;
            document.getElementById('out-not-started-pct').textContent = totalOutcomes > 0 ? `${Math.round((notStarted / totalOutcomes) * 100)}%` : '0%';
            
            // Status chart
            if (charts.outcomeStatus) charts.outcomeStatus.destroy();
            const ctx = document.getElementById('outcome-status-chart').getContext('2d');
            charts.outcomeStatus = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Completed', 'Being Implemented', 'Delayed', 'Not Started'],
                    datasets: [{
                        data: [completed, implementing, delayed, notStarted],
                        backgroundColor: ['#43A047', '#66BB6A', '#FB8C00', '#9E9E9E'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { display: false } },
                        x: { grid: { display: false } }
                    }
                }
            });
            
            // Top directives by outcome count
            const top10 = [...allDirectives]
                .filter(d => d.outcomes && d.outcomes.length > 0)
                .sort((a, b) => b.outcomes.length - a.outcomes.length)
                .slice(0, 10);
            
            if (charts.outcomeByDirective) charts.outcomeByDirective.destroy();
            const ctx2 = document.getElementById('outcome-by-directive-chart').getContext('2d');
            charts.outcomeByDirective = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: top10.map(d => (d.ref || 'N/A').substring(0, 15)),
                    datasets: [{
                        data: top10.map(d => d.outcomes.length),
                        backgroundColor: '#2196F3',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { beginAtZero: true, grid: { display: false } },
                        y: { grid: { display: false } }
                    }
                }
            });
            
            // Problematic outcomes
            const problematic = allDirectives
                .map(d => {
                    if (!d.outcomes || d.outcomes.length === 0) return null;
                    const delayedCount = d.outcomes.filter(o => o.status === 'Delayed').length;
                    const notStartedCount = d.outcomes.filter(o => o.status === 'Not Started').length;
                    const problems = delayedCount + notStartedCount;
                    return problems > 0 ? { directive: d, delayedCount, notStartedCount, problems } : null;
                })
                .filter(Boolean)
                .sort((a, b) => b.problems - a.problems)
                .slice(0, 10);
            
            document.getElementById('problematic-outcomes').innerHTML = problematic.length > 0 ? `
                <div class="space-y-2">
                    ${problematic.map((p, idx) => `
                        <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg border border-red-200">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xs font-bold text-red-600">#${idx + 1}</span>
                                    <span class="text-xs font-mono font-medium text-gray-700 truncate">${p.directive.ref || 'N/A'}</span>
                                </div>
                                <div class="text-xs text-gray-600 truncate mb-1">${p.directive.subject}</div>
                                <div class="text-xs text-gray-500">${p.delayedCount} delayed ‚Ä¢ ${p.notStartedCount} not started</div>
                            </div>
                            <div class="text-right ml-4">
                                <div class="text-3xl font-light text-red-600">${p.problems}</div>
                                <div class="text-xs text-red-600">problems</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : '<p class="text-gray-500 text-sm text-center py-6">No significant issues detected ‚úì</p>';
        }

        function renderDirectives() {
            renderDirectivesList(getFilteredDirectives());
        }

        function getFilteredDirectives() {
            let directiveAnalysis = allDirectives.map(d => {
                const hasOutcomes = d.outcomes && d.outcomes.length > 0;
                return {
                    directive: d,
                    total: hasOutcomes ? d.outcomes.length : 0,
                    completed: hasOutcomes ? d.outcomes.filter(o => o.status === 'Completed').length : 0,
                    inProgress: hasOutcomes ? d.outcomes.filter(o => o.status === 'Being Implemented').length : 0,
                    delayed: hasOutcomes ? d.outcomes.filter(o => o.status === 'Delayed').length : 0,
                    notStarted: hasOutcomes ? d.outcomes.filter(o => o.status === 'Not Started').length : 0,
                    completionRate: hasOutcomes && d.outcomes.length > 0 ? Math.round((d.outcomes.filter(o => o.status === 'Completed').length / d.outcomes.length) * 100) : 0
                };
            });
            
            // Apply filters
            if (dirFilters.status !== 'all') {
                directiveAnalysis = directiveAnalysis.filter(a => {
                    if (dirFilters.status === 'full') return a.completionRate === 100;
                    if (dirFilters.status === 'partial') return a.completionRate > 0 && a.completionRate < 100;
                    if (dirFilters.status === 'none') return a.completionRate === 0;
                    return true;
                });
            }
            
            if (dirFilters.search) {
                directiveAnalysis = directiveAnalysis.filter(a => 
                    (a.directive.subject || '').toLowerCase().includes(dirFilters.search) ||
                    (a.directive.ref || '').toLowerCase().includes(dirFilters.search) ||
                    (a.directive.owner || '').toLowerCase().includes(dirFilters.search)
                );
            }
            
            // Apply sorting
            directiveAnalysis.sort((a, b) => {
                if (dirFilters.sort === 'completion-desc') return b.completionRate - a.completionRate;
                if (dirFilters.sort === 'completion-asc') return a.completionRate - b.completionRate;
                if (dirFilters.sort === 'outcomes-desc') return b.total - a.total;
                return b.completionRate - a.completionRate;
            });
            
            return directiveAnalysis;
        }

        function renderDirectivesList(data) {
            if (data.length === 0) {
                document.getElementById('directives-list').innerHTML = '<p class="text-gray-500 text-sm text-center py-12">No directives found</p>';
                return;
            }
            
            const totalPages = Math.ceil(data.length / dirPageSize);
            const startIdx = (dirCurrentPage - 1) * dirPageSize;
            const endIdx = Math.min(startIdx + dirPageSize, data.length);
            const pageData = data.slice(startIdx, endIdx);
            
            const html = `
                <div class="text-xs text-gray-500 mb-4">Showing ${startIdx + 1}-${endIdx} of ${data.length} directives</div>
                <div class="space-y-4">
                    ${pageData.map((analysis, idx) => {
                        const d = analysis.directive;
                        const today = new Date();
                        const deadline = d.implementationEndDate ? new Date(d.implementationEndDate) : null;
                        const daysUntil = deadline ? Math.ceil((deadline - today) / (1000 * 60 * 60 * 24)) : null;
                        const isOverdue = daysUntil !== null && daysUntil < 0;
                        const isDueSoon = daysUntil !== null && daysUntil > 0 && daysUntil <= 30;
                        
                        return `
                            <div class="item-card ${d.isResponsive === false ? 'border-2 border-red-500' : ''}">
                                <!-- Header -->
                                <div class="flex items-start justify-between mb-4">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="badge ${analysis.completionRate === 100 ? 'badge-green' : analysis.completionRate >= 50 ? 'badge-blue' : 'badge-red'}">
                                                ${analysis.completionRate}% Complete
                                            </span>
                                            <span class="text-xs font-mono font-medium text-gray-700">${d.ref || 'N/A'}</span>
                                            ${d.isResponsive === false ? '<span class="badge badge-red">‚ö†Ô∏è NON-RESPONSIVE</span>' : ''}
                                            ${isOverdue ? '<span class="badge badge-red">‚è∞ OVERDUE</span>' : ''}
                                            ${isDueSoon ? '<span class="badge badge-yellow">‚è±Ô∏è DUE SOON</span>' : ''}
                                        </div>
                                        <div class="font-medium text-base text-gray-900 mb-3">${d.subject}</div>
                                        
                                        <!-- Key Metrics Row -->
                                        <div class="grid grid-cols-4 gap-3 mb-3 text-xs">
                                            <div class="bg-gray-50 rounded p-2">
                                                <div class="text-gray-500 mb-1">Owner</div>
                                                <div class="font-medium text-gray-900 truncate">${d.owner || 'Unassigned'}</div>
                                            </div>
                                            <div class="bg-gray-50 rounded p-2">
                                                <div class="text-gray-500 mb-1">Reminders</div>
                                                <div class="font-medium ${(d.reminders || 0) >= 3 ? 'text-red-600' : (d.reminders || 0) >= 2 ? 'text-yellow-600' : 'text-gray-900'}">
                                                    ${d.reminders || 0}/3 sent ${(d.reminders || 0) >= 3 ? 'üö®' : (d.reminders || 0) >= 2 ? '‚ö†Ô∏è' : (d.reminders || 0) === 1 ? 'üìß' : '‚úì'}
                                                </div>
                                            </div>
                                            <div class="bg-gray-50 rounded p-2">
                                                <div class="text-gray-500 mb-1">Deadline</div>
                                                <div class="font-medium ${isOverdue ? 'text-red-600' : isDueSoon ? 'text-yellow-600' : 'text-gray-900'}">
                                                    ${deadline ? new Date(deadline).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) : 'Not set'}
                                                </div>
                                                ${daysUntil !== null ? `
                                                    <div class="text-xs ${isOverdue ? 'text-red-600' : isDueSoon ? 'text-yellow-600' : 'text-gray-500'}">
                                                        ${isOverdue ? `${Math.abs(daysUntil)}d overdue` : `${daysUntil}d left`}
                                                    </div>
                                                ` : ''}
                                            </div>
                                            <div class="bg-gray-50 rounded p-2">
                                                <div class="text-gray-500 mb-1">Age</div>
                                                <div class="font-medium text-gray-900">
                                                    ${d.createdAt ? `${Math.ceil((today - new Date(d.createdAt)) / (1000 * 60 * 60 * 24))} days` : 'Unknown'}
                                                </div>
                                                ${d.createdAt ? `
                                                    <div class="text-xs text-gray-500">
                                                        Since ${new Date(d.createdAt).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' })}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-right ml-6 flex-shrink-0">
                                        <div class="text-5xl font-light" style="color: var(--cbn-primary);">${analysis.completionRate}%</div>
                                        <div class="text-xs text-gray-500 mt-1">${analysis.completed}/${analysis.total} done</div>
                                    </div>
                                </div>
                                
                                <!-- Outcome Status Summary -->
                                <div class="grid grid-cols-4 gap-2 mb-4">
                                    <div class="bg-green-50 rounded-lg p-3 text-center">
                                        <div class="text-2xl font-light text-green-600">${analysis.completed}</div>
                                        <div class="text-xs text-green-700 font-medium">Completed</div>
                                    </div>
                                    <div class="bg-blue-50 rounded-lg p-3 text-center">
                                        <div class="text-2xl font-light text-blue-600">${analysis.inProgress}</div>
                                        <div class="text-xs text-blue-700 font-medium">Implementing</div>
                                    </div>
                                    <div class="bg-orange-50 rounded-lg p-3 text-center">
                                        <div class="text-2xl font-light text-orange-600">${analysis.delayed}</div>
                                        <div class="text-xs text-orange-700 font-medium">Delayed</div>
                                    </div>
                                    <div class="bg-gray-100 rounded-lg p-3 text-center">
                                        <div class="text-2xl font-light text-gray-600">${analysis.notStarted}</div>
                                        <div class="text-xs text-gray-600 font-medium">Not Started</div>
                                    </div>
                                </div>
                                
                                <!-- Detailed Outcome List (if has outcomes) -->
                                ${analysis.total > 0 ? `
                                    <div class="border-t border-gray-200 pt-4">
                                        <div class="flex items-center justify-between mb-3">
                                            <div>
                                                <h4 class="text-sm font-semibold text-gray-900">
                                                    üìã All ${analysis.total} Outcomes Explained
                                                </h4>
                                                <p class="text-xs text-gray-500 mt-1">
                                                    ${analysis.completed} completed ‚Ä¢ ${analysis.inProgress} implementing ‚Ä¢ ${analysis.delayed} delayed ‚Ä¢ ${analysis.notStarted} not started
                                                </p>
                                            </div>
                                            <button onclick="toggleOutcomes('${d._id}')" class="text-xs text-blue-600 hover:text-blue-800 font-medium px-3 py-1 rounded-lg hover:bg-blue-50 transition-colors">
                                                <span id="toggle-${d._id}">‚ñº Show All Outcomes</span>
                                            </button>
                                        </div>
                                        <div id="outcomes-${d._id}" class="hidden space-y-2">${d.outcomes.map((outcome, oIdx) => {
                                                const statusStyles = {
                                                    'Completed': { bg: 'bg-green-50', border: 'border-green-200', text: 'text-green-800', badge: 'badge-green', icon: '‚úì' },
                                                    'Being Implemented': { bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-800', badge: 'badge-blue', icon: '‚öôÔ∏è' },
                                                    'Delayed': { bg: 'bg-orange-50', border: 'border-orange-200', text: 'text-orange-800', badge: 'badge-red', icon: '‚è∏Ô∏è' },
                                                    'Not Started': { bg: 'bg-gray-50', border: 'border-gray-200', text: 'text-gray-800', badge: 'bg-gray-200 text-gray-700', icon: '‚óã' }
                                                };
                                                const style = statusStyles[outcome.status] || statusStyles['Not Started'];
                                                
                                                return `
                                                    <div class="flex items-start gap-3 p-3 rounded-lg border-2 ${style.border} ${style.bg}">
                                                        <div class="flex-shrink-0 w-7 h-7 rounded-full bg-white border-2 border-current flex items-center justify-center text-sm font-bold ${style.text}">
                                                            ${oIdx + 1}
                                                        </div>
                                                        <div class="flex-1 min-w-0">
                                                            <div class="text-sm font-medium ${style.text} mb-2">${outcome.text}</div>
                                                            <div class="flex items-center gap-2 flex-wrap">
                                                                <span class="badge ${style.badge} text-xs">
                                                                    ${style.icon} ${outcome.status}
                                                                </span>
                                                                ${outcome.challenges ? `
                                                                    <div class="text-xs ${style.text} opacity-90 mt-1 w-full">
                                                                        <strong>üìù Update:</strong> ${outcome.challenges.substring(0, 100)}${outcome.challenges.length > 100 ? '...' : ''}
                                                                    </div>
                                                                ` : ''}
                                                            </div>
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                ` : '<p class="text-xs text-gray-500 italic text-center py-4">No outcomes recorded for this directive</p>'}
                                
                                <!-- Progress Bar -->
                                <div class="progress-bar mt-4">
                                    <div class="progress-fill" style="width: ${analysis.completionRate}%;"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                ${totalPages > 1 ? renderPagination(dirCurrentPage, totalPages, 'dir') : ''}
            `;
            
            document.getElementById('directives-list').innerHTML = html;
        }

        function toggleOutcomes(directiveId) {
            const outcomesDiv = document.getElementById(`outcomes-${directiveId}`);
            const toggleText = document.getElementById(`toggle-${directiveId}`);
            
            if (outcomesDiv.classList.contains('hidden')) {
                outcomesDiv.classList.remove('hidden');
                toggleText.textContent = '‚ñ≤ Hide Outcomes';
            } else {
                outcomesDiv.classList.add('hidden');
                toggleText.textContent = '‚ñº Show All Outcomes';
            }
        }

        function renderTimeline() {
            const today = new Date();
            let overdue = 0;
            let dueSoon = 0;
            let noDate = 0;
            const overdueList = [];
            
            allDirectives.forEach(d => {
                if (!d.implementationEndDate) {
                    noDate++;
                } else {
                    const deadline = new Date(d.implementationEndDate);
                    const daysUntil = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
                    
                    if (daysUntil < 0) {
                        overdue++;
                        overdueList.push({ directive: d, daysOverdue: Math.abs(daysUntil) });
                    } else if (daysUntil <= 30) {
                        dueSoon++;
                    }
                }
            });
            
            document.getElementById('tl-overdue').textContent = overdue;
            document.getElementById('tl-due-soon').textContent = dueSoon;
            document.getElementById('tl-no-date').textContent = noDate;
            
            // Timeline chart
            if (charts.timeline) charts.timeline.destroy();
            const ctx = document.getElementById('timeline-chart').getContext('2d');
            const onSchedule = allDirectives.length - overdue - dueSoon - noDate;
            
            charts.timeline = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Overdue', 'Due Soon', 'On Schedule', 'No Timeline'],
                    datasets: [{
                        data: [overdue, dueSoon, onSchedule, noDate],
                        backgroundColor: ['#C62828', '#FB8C00', '#43A047', '#9E9E9E'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { beginAtZero: true, grid: { display: false } },
                        y: { grid: { display: false } }
                    }
                }
            });
            
            // Overdue list
            overdueList.sort((a, b) => b.daysOverdue - a.daysOverdue);
            document.getElementById('overdue-list').innerHTML = overdueList.length > 0 ? `
                <div class="space-y-2">
                    ${overdueList.slice(0, 10).map(item => `
                        <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg border border-red-200">
                            <div class="flex-1 min-w-0">
                                <div class="text-xs font-mono font-medium text-gray-700 truncate mb-1">${item.directive.ref || 'N/A'}</div>
                                <div class="text-xs text-gray-600 truncate">${item.directive.subject}</div>
                            </div>
                            <div class="text-right ml-4">
                                <div class="text-2xl font-light text-red-600">${item.daysOverdue}</div>
                                <div class="text-xs text-red-600">days overdue</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : '<p class="text-gray-500 text-sm text-center py-6">No overdue directives ‚úì</p>';
        }

        function renderOwners() {
            const ownerStats = {};
            
            allDirectives.forEach(d => {
                const owner = d.owner || 'Unassigned';
                if (!ownerStats[owner]) {
                    ownerStats[owner] = {
                        name: owner,
                        directivesTotal: 0,
                        totalOutcomes: 0,
                        completedOutcomes: 0
                    };
                }
                
                ownerStats[owner].directivesTotal++;
                
                if (d.outcomes && d.outcomes.length > 0) {
                    ownerStats[owner].totalOutcomes += d.outcomes.length;
                    ownerStats[owner].completedOutcomes += d.outcomes.filter(o => o.status === 'Completed').length;
                }
            });
            
            let owners = Object.values(ownerStats).map(owner => {
                owner.completionRate = owner.totalOutcomes > 0 ? Math.round((owner.completedOutcomes / owner.totalOutcomes) * 100) : 0;
                return owner;
            });
            
            // Top 10 chart
            const top10 = [...owners].sort((a, b) => b.completionRate - a.completionRate).slice(0, 10);
            
            if (charts.topOwners) charts.topOwners.destroy();
            const ctx = document.getElementById('top-owners-chart').getContext('2d');
            charts.topOwners = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10.map(o => o.name.substring(0, 25)),
                    datasets: [{
                        label: 'Completion Rate (%)',
                        data: top10.map(o => o.completionRate),
                        backgroundColor: '#43A047',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { beginAtZero: true, max: 100, grid: { display: false } },
                        y: { grid: { display: false } }
                    }
                }
            });
            
            renderOwnersList(getFilteredOwners());
        }

        function getFilteredOwners() {
            const ownerStats = {};
            
            allDirectives.forEach(d => {
                const owner = d.owner || 'Unassigned';
                if (!ownerStats[owner]) {
                    ownerStats[owner] = {
                        name: owner,
                        directivesTotal: 0,
                        totalOutcomes: 0,
                        completedOutcomes: 0
                    };
                }
                
                ownerStats[owner].directivesTotal++;
                
                if (d.outcomes && d.outcomes.length > 0) {
                    ownerStats[owner].totalOutcomes += d.outcomes.length;
                    ownerStats[owner].completedOutcomes += d.outcomes.filter(o => o.status === 'Completed').length;
                }
            });
            
            let owners = Object.values(ownerStats).map(owner => {
                owner.completionRate = owner.totalOutcomes > 0 ? Math.round((owner.completedOutcomes / owner.totalOutcomes) * 100) : 0;
                return owner;
            });
            
            // Apply filters
            if (ownerFilters.performance !== 'all') {
                owners = owners.filter(o => {
                    if (ownerFilters.performance === 'excellent') return o.completionRate >= 80;
                    if (ownerFilters.performance === 'good') return o.completionRate >= 60 && o.completionRate < 80;
                    if (ownerFilters.performance === 'needs-improvement') return o.completionRate < 60;
                    return true;
                });
            }
            
            if (ownerFilters.search) {
                owners = owners.filter(o => o.name.toLowerCase().includes(ownerFilters.search));
            }
            
            // Apply sorting
            owners.sort((a, b) => {
                if (ownerFilters.sort === 'completion-desc') return b.completionRate - a.completionRate;
                if (ownerFilters.sort === 'outcomes-desc') return b.totalOutcomes - a.totalOutcomes;
                if (ownerFilters.sort === 'directives-desc') return b.directivesTotal - a.directivesTotal;
                return b.completionRate - a.completionRate;
            });
            
            return owners;
        }

        function renderOwnersList(data) {
            if (data.length === 0) {
                document.getElementById('owners-list').innerHTML = '<p class="text-gray-500 text-sm text-center py-12">No owners found</p>';
                return;
            }
            
            const totalPages = Math.ceil(data.length / ownerPageSize);
            const startIdx = (ownerCurrentPage - 1) * ownerPageSize;
            const endIdx = Math.min(startIdx + ownerPageSize, data.length);
            const pageData = data.slice(startIdx, endIdx);
            
            const html = `
                <div class="text-xs text-gray-500 mb-4">Showing ${startIdx + 1}-${endIdx} of ${data.length} process owners</div>
                <div class="space-y-3">
                    ${pageData.map((owner, idx) => {
                        const globalIdx = startIdx + idx;
                        const gradeColor = owner.completionRate >= 80 ? 'green' : 
                                           owner.completionRate >= 60 ? 'blue' : 'red';
                        
                        return `
                            <div class="item-card">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-3 mb-2">
                                            <span class="badge badge-${gradeColor}">Rank #${globalIdx + 1}</span>
                                            <span class="text-lg font-medium" style="color: var(--cbn-dark);">${owner.name}</span>
                                        </div>
                                        <div class="grid grid-cols-3 gap-4 text-sm">
                                            <div>
                                                <div class="text-xs text-gray-500 mb-1">Directives</div>
                                                <div class="font-medium text-xl">${owner.directivesTotal}</div>
                                            </div>
                                            <div>
                                                <div class="text-xs text-gray-500 mb-1">Total Outcomes</div>
                                                <div class="font-medium text-xl">${owner.totalOutcomes}</div>
                                            </div>
                                            <div>
                                                <div class="text-xs text-gray-500 mb-1">Completed</div>
                                                <div class="font-medium text-xl text-green-600">${owner.completedOutcomes}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-right ml-6">
                                        <div class="text-4xl font-light" style="color: var(--cbn-primary);">${owner.completionRate}%</div>
                                        <div class="text-xs text-gray-500 mt-1">completion</div>
                                    </div>
                                </div>
                                <div class="progress-bar mt-3">
                                    <div class="progress-fill" style="width: ${owner.completionRate}%;"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                
                ${totalPages > 1 ? renderPagination(ownerCurrentPage, totalPages, 'owner') : ''}
            `;
            
            document.getElementById('owners-list').innerHTML = html;
        }

        function renderPagination(currentPage, totalPages, type) {
            const maxButtons = 7;
            let startPage, endPage;
            
            if (totalPages <= maxButtons) {
                startPage = 1;
                endPage = totalPages;
            } else if (currentPage <= 4) {
                startPage = 1;
                endPage = maxButtons;
            } else if (currentPage >= totalPages - 3) {
                startPage = totalPages - maxButtons + 1;
                endPage = totalPages;
            } else {
                startPage = currentPage - 3;
                endPage = currentPage + 3;
            }
            
            let buttons = '';
            for (let i = startPage; i <= endPage; i++) {
                buttons += `
                    <button onclick="changePage('${type}', ${i})" 
                            class="${i === currentPage ? 'active' : ''}">
                        ${i}
                    </button>
                `;
            }
            
            return `
                <div class="pagination no-print">
                    <button onclick="changePage('${type}', ${currentPage - 1})" 
                            ${currentPage === 1 ? 'disabled' : ''}>
                        ‚Üê Previous
                    </button>
                    ${buttons}
                    <button onclick="changePage('${type}', ${currentPage + 1})" 
                            ${currentPage === totalPages ? 'disabled' : ''}>
                        Next ‚Üí
                    </button>
                </div>
            `;
        }

        function changePage(type, page) {
            if (type === 'dir') {
                dirCurrentPage = page;
                renderDirectivesList(getFilteredDirectives());
            } else if (type === 'owner') {
                ownerCurrentPage = page;
                renderOwnersList(getFilteredOwners());
            }
        }

        function exportReport() {
            const wb = XLSX.utils.book_new();
            
            const summaryData = [
                ['Board Directives Report'],
                ['Date:', new Date().toLocaleDateString()],
                ['Source:', currentSource === 'CG' ? 'Council of Governors' : 'Board of Directors'],
                [],
                ['Metric', 'Value'],
                ['Total Directives', allDirectives.length],
                ['Total Outcomes', allDirectives.reduce((sum, d) => sum + (d.outcomes ? d.outcomes.length : 0), 0)],
                ['Completed Outcomes', allDirectives.reduce((sum, d) => sum + (d.outcomes ? d.outcomes.filter(o => o.status === 'Completed').length : 0), 0)]
            ];
            
            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Summary');
            
            const detailsData = allDirectives.map(d => ({
                'Ref': d.ref || 'N/A',
                'Subject': d.subject,
                'Owner': d.owner,
                'Total Outcomes': d.outcomes?.length || 0,
                'Completed': d.outcomes?.filter(o => o.status === 'Completed').length || 0,
                'Being Implemented': d.outcomes?.filter(o => o.status === 'Being Implemented').length || 0,
                'Delayed': d.outcomes?.filter(o => o.status === 'Delayed').length || 0,
                'Not Started': d.outcomes?.filter(o => o.status === 'Not Started').length || 0
            }));
            
            const ws2 = XLSX.utils.json_to_sheet(detailsData);
            XLSX.utils.book_append_sheet(wb, ws2, 'Directives');
            
            XLSX.writeFile(wb, `Report_${currentSource}_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
    </script>
</body>
</html>