<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Management - CBN Directives</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        
        .owner-card {
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
        }
        
        .owner-card.has-email {
            border-left-color: #10b981;
        }
        
        .owner-card.no-email {
            border-left-color: #f59e0b;
        }
        
        .owner-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .save-btn {
            transition: all 0.2s ease;
        }
        
        .save-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div class="max-w-4xl mx-auto py-8 px-4">
        
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">üìß Email Management</h1>
                    <p class="text-gray-600">Assign email addresses to process owners</p>
                </div>
                <a href="/" class="px-5 py-2.5 bg-gray-100 text-gray-700 font-semibold rounded-xl hover:bg-gray-200 transition-colors">
                    ‚Üê Back
                </a>
            </div>
        </div>

        <!-- Search -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-4 mb-6">
            <input 
                type="text" 
                id="searchOwner" 
                placeholder="üîç Search process owners..." 
                class="w-full px-5 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-gray-900 font-medium"
            >
        </div>

        <!-- Loading -->
        <div id="loading" class="bg-white rounded-2xl shadow-sm border border-gray-200 p-16 text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-200 border-t-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-600 font-medium">Loading process owners...</p>
        </div>

        <!-- Process Owners List -->
        <div id="ownersContainer" class="hidden space-y-4"></div>

        <!-- No Results -->
        <div id="noResults" class="hidden bg-white rounded-2xl shadow-sm border border-gray-200 p-16 text-center">
            <div class="text-6xl mb-4">üîç</div>
            <p class="text-gray-600 font-medium text-lg">No process owners found</p>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="successToast" class="hidden fixed bottom-6 right-6 bg-green-600 text-white px-6 py-4 rounded-xl shadow-2xl animate-slide-up">
        <div class="flex items-center">
            <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
            </svg>
            <span id="successMessage" class="font-semibold"></span>
        </div>
    </div>

    <script>
        let ownersData = [];

        async function loadOwners() {
            try {
                const response = await fetch('/api/process-owners-with-directives');
                const data = await response.json();
                
                if (!data.success) throw new Error(data.error);
                
                ownersData = data.data;
                displayOwners(ownersData);
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('ownersContainer').classList.remove('hidden');
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading data: ' + error.message);
            }
        }

        function displayOwners(owners) {
            const container = document.getElementById('ownersContainer');
            
            if (owners.length === 0) {
                container.classList.add('hidden');
                document.getElementById('noResults').classList.remove('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            document.getElementById('noResults').classList.add('hidden');
            
            container.innerHTML = owners.map(owner => {
                const hasEmail = owner.primaryEmail && owner.primaryEmail.trim() !== '';
                const cardClass = hasEmail ? 'has-email' : 'no-email';
                const statusIcon = hasEmail ? '‚úÖ' : '‚ö†Ô∏è';
                
                return `
                    <div class="owner-card ${cardClass} bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl">${statusIcon}</div>
                                <div>
                                    <h3 class="text-xl font-bold text-gray-900">${owner.name}</h3>
                                    <p class="text-sm text-gray-500">${owner.directiveCount} directive${owner.directiveCount !== 1 ? 's' : ''}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            <input 
                                type="email" 
                                id="email-${owner.name}"
                                value="${owner.primaryEmail || ''}"
                                placeholder="Enter email address"
                                class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all font-medium"
                            >
                            <button 
                                onclick="saveEmail('${owner.name}')" 
                                class="save-btn px-8 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700"
                            >
                                Save
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function saveEmail(ownerName) {
            const emailInput = document.getElementById(`email-${ownerName}`);
            const email = emailInput.value.trim();
            
            try {
                const response = await fetch('/api/update-owner-emails', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        owner: ownerName,
                        primaryEmail: email,
                        secondaryEmail: ''
                    })
                });
                
                const data = await response.json();
                
                if (!data.success) throw new Error(data.error);
                
                showToast(`‚úÖ Email saved for ${ownerName}`);
                
                // Update local data
                const owner = ownersData.find(o => o.name === ownerName);
                if (owner) {
                    owner.primaryEmail = email;
                    displayOwners(filterOwners());
                }
                
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        function filterOwners() {
            const searchTerm = document.getElementById('searchOwner').value.toLowerCase();
            return ownersData.filter(owner => 
                owner.name.toLowerCase().includes(searchTerm)
            );
        }

        function showToast(message) {
            const toast = document.getElementById('successToast');
            document.getElementById('successMessage').textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // Search functionality
        document.getElementById('searchOwner').addEventListener('input', () => {
            displayOwners(filterOwners());
        });

        // Load on page load
        loadOwners();
    </script>
</body>
</html>